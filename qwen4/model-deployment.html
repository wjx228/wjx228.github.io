<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qwen 7B æœ¬åœ°æ¨¡å‹äº¤äº’ï¼ˆæ™ºèƒ½å¯¹è¯ç‰ˆï¼‰</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#5B6CF6',
                        'primary-light': '#7886F5',
                        secondary: '#10B981',
                        'secondary-light': '#34D399',
                        code: '#F59E0B',
                        'code-light': '#FBBF24',
                        bg: '#F5F7FA',
                        'chat-bg': '#FFFFFF',
                        'user-bg': '#E6F4FF',
                        'ai-bg': '#F9FAFB',
                        text: '#1D2939',
                        'text-light': '#667085',
                        border: '#E5E7EB',
                    },
                    fontFamily: {
                        inter: ['Inter', 'system-ui', 'sans-serif'],
                    },
                    boxShadow: {
                        chat: '0 4px 12px rgba(0, 0, 0, 0.05)',
                        message: '0 2px 8px rgba(0, 0, 0, 0.07)',
                        button: '0 4px 14px rgba(91, 108, 246, 0.25)',
                        'code-button': '0 4px 14px rgba(245, 158, 11, 0.25)',
                        'dashboard-button': '0 4px 14px rgba(16, 185, 129, 0.25)',
                    }
                },
            }
        }
    </script>
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .message-in {
                animation: slideInLeft 0.3s ease forwards;
            }
            .message-out {
                animation: slideInRight 0.3s ease forwards;
            }
            .typing-indicator {
                display: flex;
                align-items: center;
                gap: 4px;
            }
            .typing-indicator span {
                width: 8px;
                height: 8px;
                background-color: #5B6CF6;
                border-radius: 50%;
                animation: typing 1.4s infinite ease-in-out both;
            }
            .typing-indicator span:nth-child(1) { animation-delay: -0.32s; }
            .typing-indicator span:nth-child(2) { animation-delay: -0.16s; }
        }

        @keyframes slideInLeft {
            from { transform: translateX(-20px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        @keyframes slideInRight {
            from { transform: translateX(20px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        @keyframes typing {
            0% { transform: scale(0); }
            40% { transform: scale(1); }
            80% { transform: scale(0); }
            100% { transform: scale(0); }
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-5px); }
        }
        
        .pulse {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        
        .float {
            animation: float 3s ease-in-out infinite;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-bg to-slate-100 min-h-screen font-inter text-text">
    <!-- é¡¶éƒ¨è£…é¥°æ¡ -->
    <div class="h-1 w-full bg-gradient-to-r from-primary via-code to-secondary"></div>
    
    <div class="max-w-3xl mx-auto px-4 py-8 md:py-12">
        <!-- æ ‡é¢˜åŒºåŸŸ -->
        <header class="mb-8 text-center relative">
            <!-- æ–°å¢ï¼šåŠŸèƒ½åˆ‡æ¢æŒ‰é’®åŒºåŸŸ -->
            <div class="absolute right-0 top-0 flex gap-3">
                <!-- æ–°å¢ï¼šä»ªè¡¨ç›˜æŒ‰é’® -->
                <button id="switchToDashboardBtn" 
                        class="bg-gradient-to-r from-secondary to-secondary-light hover:from-secondary-light hover:to-secondary text-white px-4 py-2 rounded-xl font-medium shadow-dashboard-button hover:shadow-lg hover:-translate-y-0.5 active:translate-y-0 transition-all duration-300 flex items-center gap-2 float"
                        title="åˆ‡æ¢åˆ°è‡ªåŠ¨åˆ†æä»ªè¡¨ç›˜">
                    <i class="fa fa-dashboard"></i>
                    <span class="hidden sm:inline">åˆ†æä»ªè¡¨ç›˜</span>
                </button>
                
                <button id="switchToCodeBtn" 
                        class="bg-gradient-to-r from-code to-code-light hover:from-code-light hover:to-code text-white px-4 py-2 rounded-xl font-medium shadow-code-button hover:shadow-lg hover:-translate-y-0.5 active:translate-y-0 transition-all duration-300 flex items-center gap-2 float"
                        title="åˆ‡æ¢åˆ°ä»£ç åˆ†æå™¨">
                    <i class="fa fa-code"></i>
                    <span class="hidden sm:inline">ä»£ç åˆ†æå™¨</span>
                </button>
            </div>
            
            <div class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-gradient-to-br from-primary to-primary-light mb-4 shadow-lg">
                <i class="fa fa-comments text-white text-2xl"></i>
            </div>
            <h1 class="text-[clamp(1.5rem,3vw,2.25rem)] font-bold bg-clip-text text-transparent bg-gradient-to-r from-primary to-secondary mb-2">
                Qwen 7B æœ¬åœ°æ¨¡å‹äº¤äº’
            </h1>
            <p class="text-text-light text-sm md:text-base max-w-md mx-auto">
                æ™ºèƒ½å¯¹è¯ç‰ˆ Â· æœ¬åœ°éƒ¨ç½² Â· éšç§ä¿æŠ¤ Â· æ”¯æŒè¿ç»­å¯¹è¯
            </p>
            
            <!-- æ–°å¢ï¼šå¿«æ·æŒ‡ä»¤æ  -->
            <div class="mt-6 flex flex-wrap justify-center gap-3">
                <button class="quick-command bg-gradient-to-r from-primary/10 to-primary/5 hover:from-primary/20 hover:to-primary/10 border border-primary/20 text-primary hover:text-primary-light px-3 py-2 rounded-lg text-sm font-medium transition-all duration-300 flex items-center gap-2"
                        data-command="ä½ å¥½ï¼å¸®æˆ‘å†™ä¸€ä¸ªPythonå‡½æ•°æ¥è®¡ç®—æ–æ³¢é‚£å¥‘æ•°åˆ—ã€‚">
                    <i class="fa fa-python"></i>
                    Pythonç¤ºä¾‹
                </button>
                <button class="quick-command bg-gradient-to-r from-secondary/10 to-secondary/5 hover:from-secondary/20 hover:to-secondary/10 border border-secondary/20 text-secondary hover:text-secondary-light px-3 py-2 rounded-lg text-sm font-medium transition-all duration-300 flex items-center gap-2"
                        data-command="ç”¨ä¸­æ–‡è§£é‡Šä¸€ä¸‹ä»€ä¹ˆæ˜¯é—­åŒ…ï¼Œå¹¶ç»™å‡ºä¸€ä¸ªJavaScriptçš„ä¾‹å­ã€‚">
                    <i class="fa fa-js"></i>
                    JSç¤ºä¾‹
                </button>
                <button class="quick-command bg-gradient-to-r from-code/10 to-code/5 hover:from-code/20 hover:to-code/10 border border-code/20 text-code hover:text-code-light px-3 py-2 rounded-lg text-sm font-medium transition-all duration-300 flex items-center gap-2"
                        data-command="å¸®æˆ‘åˆ†æä¸€ä¸‹è¿™æ®µä»£ç çš„æ€§èƒ½é—®é¢˜ï¼š[ç²˜è´´ä»£ç ]">
                    <i class="fa fa-line-chart"></i>
                    ä»£ç åˆ†æ
                </button>
            </div>
        </header>

        <!-- èŠå¤©å®¹å™¨ -->
        <div id="chat-container" class="h-[600px] bg-chat-bg rounded-2xl shadow-chat p-4 md:p-6 overflow-y-auto mb-6 transition-all duration-300">
            <!-- æ¬¢è¿æ¶ˆæ¯ -->
            <div class="flex items-start mb-4 message-in">
                <div class="w-10 h-10 rounded-full bg-gradient-to-br from-secondary to-secondary-light flex items-center justify-center text-white font-bold shadow-md mr-3">
                    <i class="fa fa-robot"></i>
                </div>
                <div class="bg-ai-bg rounded-2xl rounded-tl-none px-5 py-3 shadow-message max-w-[80%]">
                    <p>ä½ å¥½ï¼æˆ‘æ˜¯åŸºäº Qwen 7B æ¨¡å‹çš„æœ¬åœ°æ™ºèƒ½åŠ©æ‰‹ï¼Œæœ‰ä»€ä¹ˆå¯ä»¥å¸®åŠ©ä½ çš„å—ï¼Ÿ</p>
                    <p class="mt-2 text-sm text-text-light">
                        ğŸ’¡ <strong>å°æç¤ºï¼š</strong> 
                        <span class="text-code cursor-pointer hover:underline" id="code-analysis-hint">
                            ç‚¹å‡»è¿™é‡Œæˆ–å³ä¸Šè§’æŒ‰é’®å¯ä»¥è¿›å…¥ä»£ç åˆ†æå™¨ï¼Œè‡ªåŠ¨åˆ†æä»£ç ç»“æ„ã€æ€§èƒ½ï¼Œå¹¶åœ¨è¿è¡Œæ—¶æä¾›æ™ºèƒ½å»ºè®®ï¼
                        </span>
                        <br>
                        <span class="text-secondary cursor-pointer hover:underline" id="dashboard-hint">
                            ç‚¹å‡»è¿™é‡Œæˆ–å³ä¸Šè§’"åˆ†æä»ªè¡¨ç›˜"æŒ‰é’®å¯ä»¥æŸ¥çœ‹è‡ªåŠ¨åˆ†æç»“æœå’Œæ•°æ®å¯è§†åŒ–é¢æ¿ï¼
                        </span>
                    </p>
                </div>
            </div>
        </div>

        <!-- è¾“å…¥åŒºåŸŸ -->
        <div class="relative group">
            <div class="absolute inset-0 bg-gradient-to-r from-primary/20 via-code/20 to-secondary/20 rounded-2xl blur opacity-0 group-hover:opacity-100 transition duration-500"></div>
            <div class="relative bg-chat-bg rounded-2xl shadow-chat p-3 flex gap-3">
                <textarea 
                    id="question" 
                    placeholder="è¾“å…¥ä½ çš„é—®é¢˜...ï¼ˆæŒ‰ Enter å‘é€ï¼ŒShift+Enter æ¢è¡Œï¼‰" 
                    class="flex-1 px-4 py-3 rounded-xl bg-bg border border-border focus:border-primary focus:ring-2 focus:ring-primary/20 outline-none resize-none transition-all duration-300 min-h-[56px] max-h-[200px]"
                ></textarea>
                <div class="flex flex-col gap-2">
                    <div class="flex gap-2">
                        <button id="clearBtn" class="bg-slate-100 hover:bg-slate-200 text-text-light px-4 py-3 rounded-xl font-medium transition-all duration-300 flex items-center gap-2">
                            <i class="fa fa-trash-o"></i>
                            <span class="hidden sm:inline">æ¸…ç©º</span>
                        </button>
                        <button id="submit" class="bg-gradient-to-r from-primary to-primary-light hover:from-primary-light hover:to-primary text-white px-6 py-3 rounded-xl font-medium shadow-button hover:shadow-lg hover:-translate-y-0.5 active:translate-y-0 transition-all duration-300 flex items-center gap-2">
                            <span>å‘é€</span>
                            <i class="fa fa-paper-plane"></i>
                        </button>
                    </div>
                    <!-- æ–°å¢ï¼šä»£ç æ£€æµ‹å¿«æ·æŒ‰é’® -->
                    <div class="flex gap-2">
                        <button id="quickCodeBtn" 
                                class="flex-1 bg-gradient-to-r from-code to-code-light hover:from-code-light hover:to-code text-white px-4 py-2 rounded-xl font-medium shadow-code-button hover:shadow-lg transition-all duration-300 flex items-center justify-center gap-2 text-sm">
                            <i class="fa fa-magic"></i>
                            ä»£ç æ£€æµ‹åŠ©æ‰‹
                        </button>
                        <button id="quickDashboardBtn" 
                                class="flex-1 bg-gradient-to-r from-secondary to-secondary-light hover:from-secondary-light hover:to-secondary text-white px-4 py-2 rounded-xl font-medium shadow-dashboard-button hover:shadow-lg transition-all duration-300 flex items-center justify-center gap-2 text-sm">
                            <i class="fa fa-bar-chart"></i>
                            åˆ†æä»ªè¡¨ç›˜
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- åº•éƒ¨ä¿¡æ¯ -->
        <div class="mt-6 text-center text-text-light text-xs">
            <p>æ¨¡å‹è¿è¡Œä¸­ Â· æœ¬åœ°éƒ¨ç½² Qwen 7B | å¯¹è¯å†å²ä»…ä¿å­˜åœ¨æœ¬åœ° | æ”¯æŒä¸Šä¸‹æ–‡å…³è”</p>
            <p class="mt-1">
                <span class="text-code font-medium">âœ¨ æ–°åŠŸèƒ½ï¼š</span> 
                ç°åœ¨å¯ä»¥ä½¿ç”¨ä»£ç åˆ†æå™¨æ£€æµ‹ä»£ç è´¨é‡ã€æ€§èƒ½é—®é¢˜å’Œæä¾›ä¼˜åŒ–å»ºè®®ï¼
                <span class="text-secondary font-medium ml-2">ğŸ“Š æ–°å¢ï¼š</span>
                è‡ªåŠ¨åˆ†æä»ªè¡¨ç›˜æä¾›å¯è§†åŒ–æ•°æ®åˆ†æå’Œè¿è¡Œç›‘æ§ï¼
            </p>
        </div>
    </div>

    <!-- æ–°å¢ï¼šä»£ç æ£€æµ‹æ¨¡æ€æ¡† -->
    <div id="codeModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden items-center justify-center p-4">
        <div class="bg-white rounded-2xl max-w-md w-full max-h-[90vh] overflow-y-auto">
            <div class="p-6">
                <div class="flex items-center justify-between mb-6">
                    <div class="flex items-center gap-3">
                        <div class="w-12 h-12 rounded-full bg-gradient-to-r from-code to-code-light flex items-center justify-center">
                            <i class="fa fa-code text-white text-xl"></i>
                        </div>
                        <div>
                            <h3 class="text-lg font-bold text-text">ä»£ç åˆ†æå™¨</h3>
                            <p class="text-sm text-text-light">æ™ºèƒ½ä»£ç æ£€æµ‹ä¸ä¼˜åŒ–</p>
                        </div>
                    </div>
                    <button id="closeModal" class="text-text-light hover:text-text text-xl">
                        <i class="fa fa-times"></i>
                    </button>
                </div>
                
                <div class="space-y-4">
                    <div class="bg-gradient-to-r from-code/5 to-code/10 border border-code/20 rounded-xl p-4">
                        <h4 class="font-medium text-code mb-2 flex items-center gap-2">
                            <i class="fa fa-star"></i> ä¸»è¦åŠŸèƒ½
                        </h4>
                        <ul class="text-sm space-y-1 pl-5">
                            <li class="flex items-start gap-2">
                                <i class="fa fa-check text-green-500 mt-1"></i>
                                <span>è‡ªåŠ¨è§£æä»£ç ç»“æ„å’Œç”¨é€”</span>
                            </li>
                            <li class="flex items-start gap-2">
                                <i class="fa fa-check text-green-500 mt-1"></i>
                                <span>è¿è¡Œæ—¶æ€§èƒ½åˆ†æå’Œç›‘æ§</span>
                            </li>
                            <li class="flex items-start gap-2">
                                <i class="fa fa-check text-green-500 mt-1"></i>
                                <span>ä»£ç ä¼˜åŠ£æ¯”è¾ƒå’Œä¼˜åŒ–å»ºè®®</span>
                            </li>
                            <li class="flex items-start gap-2">
                                <i class="fa fa-check text-green-500 mt-1"></i>
                                <span>å®‰å…¨æ£€æµ‹å’Œæ½œåœ¨é—®é¢˜é¢„è­¦</span>
                            </li>
                        </ul>
                    </div>
                    
                    <div class="flex gap-3">
                        <button id="openCodeAnalyzer" 
                                class="flex-1 bg-gradient-to-r from-code to-code-light hover:from-code-light hover:to-code text-white px-4 py-3 rounded-xl font-medium shadow-code-button hover:shadow-lg transition-all duration-300 flex items-center justify-center gap-2">
                            <i class="fa fa-external-link"></i>
                            æ‰“å¼€ä»£ç åˆ†æå™¨
                        </button>
                        <button id="pasteCodeHere" 
                                class="flex-1 bg-gradient-to-r from-primary to-primary-light hover:from-primary-light hover:to-primary text-white px-4 py-3 rounded-xl font-medium shadow-button hover:shadow-lg transition-all duration-300 flex items-center justify-center gap-2">
                            <i class="fa fa-paste"></i>
                            ç²˜è´´ä»£ç åˆ†æ
                        </button>
                    </div>
                    
                    <div class="text-center text-xs text-text-light mt-4">
                        <p>æˆ–è€…ç›´æ¥åœ¨èŠå¤©æ¡†ä¸­è¾“å…¥ä»£ç è¿›è¡Œå¿«é€Ÿåˆ†æ</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // åŠ¨æ€è·å–å½“å‰é¡µé¢çš„åè®®ã€IP/åŸŸåã€ç«¯å£
        const currentOrigin = window.location.origin; 
        // æ‹¼æ¥Ollama APIåœ°å€
        const OLLAMA_API = currentOrigin + '/api/chat';
        // ä»£ç åˆ†æå™¨é¡µé¢åœ°å€
        const CODE_ANALYZER_URL = currentOrigin.replace(':5000', ':5000') + '/code_analysis.html';
        // è‡ªåŠ¨åˆ†æä»ªè¡¨ç›˜é¡µé¢åœ°å€
        const AUTO_ANALYSIS_DASHBOARD_URL = currentOrigin.replace(':5000', ':5000') + '/auto_analysis_dashboard.html';
        
        const chatContainer = document.getElementById("chat-container");
        const questionInput = document.getElementById("question");
        const submitBtn = document.getElementById("submit");
        const clearBtn = document.getElementById("clearBtn");
        const switchToCodeBtn = document.getElementById("switchToCodeBtn");
        const switchToDashboardBtn = document.getElementById("switchToDashboardBtn"); // æ–°å¢
        const quickCodeBtn = document.getElementById("quickCodeBtn");
        const quickDashboardBtn = document.getElementById("quickDashboardBtn"); // æ–°å¢
        const codeModal = document.getElementById("codeModal");
        const closeModal = document.getElementById("closeModal");
        const openCodeAnalyzer = document.getElementById("openCodeAnalyzer");
        const pasteCodeHere = document.getElementById("pasteCodeHere");
        const codeAnalysisHint = document.getElementById("code-analysis-hint");
        const dashboardHint = document.getElementById("dashboard-hint"); // æ–°å¢

        // å…³é”®ï¼šä¿å­˜å†å²å¯¹è¯è®°å½•ï¼ˆç”¨äºä¸Šä¸‹æ–‡å…³è”ï¼‰
        let chatHistory = [
            { role: "assistant", content: "ä½ å¥½ï¼æˆ‘æ˜¯åŸºäº Qwen 7B æ¨¡å‹çš„æœ¬åœ°æ™ºèƒ½åŠ©æ‰‹ï¼Œæœ‰ä»€ä¹ˆå¯ä»¥å¸®åŠ©ä½ çš„å—ï¼Ÿ\n\nğŸ’¡ å°æç¤ºï¼šç‚¹å‡»è¿™é‡Œæˆ–å³ä¸Šè§’æŒ‰é’®å¯ä»¥è¿›å…¥ä»£ç åˆ†æå™¨ï¼Œè‡ªåŠ¨åˆ†æä»£ç ç»“æ„ã€æ€§èƒ½ï¼Œå¹¶åœ¨è¿è¡Œæ—¶æä¾›æ™ºèƒ½å»ºè®®ï¼\nç‚¹å‡»è¿™é‡Œæˆ–å³ä¸Šè§’\"åˆ†æä»ªè¡¨ç›˜\"æŒ‰é’®å¯ä»¥æŸ¥çœ‹è‡ªåŠ¨åˆ†æç»“æœå’Œæ•°æ®å¯è§†åŒ–é¢æ¿ï¼" }
        ];

        // å”¯ä¸€ç”¨æˆ·æ ‡è¯†
        const USER_ID = "local_user_" + Date.now(); 

        // æ»šåŠ¨åˆ°åº•éƒ¨
        function scrollToBottom() {
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        // æ ¼å¼åŒ–æ¶ˆæ¯å†…å®¹ï¼ˆå¤„ç†æ¢è¡Œå’Œåˆ—è¡¨ï¼‰
        function formatMessage(content) {
            return content
                .replace(/\n\n/g, '<br><br>')
                .replace(/\n(?=[^\n])/g, '<br>')
                .replace(/\* (.*?)(?=\n|$)/g, '<li class="ml-4 list-disc">$1</li>')
                .replace(/(<li.*?<\/li>)/gs, '<ul class="my-2">$1</ul>')
                .replace(/```([\s\S]*?)```/g, '<pre class="bg-slate-100 p-3 rounded-lg my-2 overflow-x-auto text-sm">$1</pre>')
                .replace(/`([^`]+)`/g, '<code class="bg-slate-100 px-1 py-0.5 rounded text-sm font-mono">$1</code>');
        }

        // æ·»åŠ æ¶ˆæ¯åˆ°èŠå¤©å®¹å™¨
        function addMessage(role, content) {
            const div = document.createElement("div");
            const formattedContent = formatMessage(content);
            
            if (role === "user") {
                // ç”¨æˆ·æ¶ˆæ¯ï¼šé å³æ˜¾ç¤º
                div.className = "flex items-start justify-end mb-4 message-out";
                div.innerHTML = `
                    <div class="bg-user-bg rounded-2xl rounded-tr-none px-5 py-3 shadow-message max-w-[80%]">
                        ${formattedContent}
                    </div>
                    <div class="w-10 h-10 rounded-full bg-gradient-to-br from-primary to-primary-light flex items-center justify-center text-white font-bold shadow-md ml-3">
                        <i class="fa fa-user"></i>
                    </div>
                `;
            } else {
                // AIæ¶ˆæ¯ï¼šé å·¦æ˜¾ç¤º
                div.className = "flex items-start mb-4 message-in";
                div.innerHTML = `
                    <div class="w-10 h-10 rounded-full bg-gradient-to-br from-secondary to-secondary-light flex items-center justify-center text-white font-bold shadow-md mr-3">
                        <i class="fa fa-robot"></i>
                    </div>
                    <div class="bg-ai-bg rounded-2xl rounded-tl-none px-5 py-3 shadow-message max-w-[80%]">
                        ${formattedContent}
                    </div>
                `;
            }
            
            chatContainer.appendChild(div);
            scrollToBottom();
        }

        // æ¸…ç©ºèŠå¤©è®°å½•
        function clearChat() {
            if (confirm("ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰èŠå¤©è®°å½•å—ï¼Ÿ")) {
                chatContainer.innerHTML = "";
                chatHistory = [];
                // æ·»åŠ åˆå§‹æ¬¢è¿æ¶ˆæ¯
                const welcomeMsg = "ä½ å¥½ï¼æˆ‘æ˜¯åŸºäº Qwen 7B æ¨¡å‹çš„æœ¬åœ°æ™ºèƒ½åŠ©æ‰‹ï¼Œæœ‰ä»€ä¹ˆå¯ä»¥å¸®åŠ©ä½ çš„å—ï¼Ÿ\n\nğŸ’¡ å°æç¤ºï¼šç‚¹å‡»è¿™é‡Œæˆ–å³ä¸Šè§’æŒ‰é’®å¯ä»¥è¿›å…¥ä»£ç åˆ†æå™¨ï¼Œè‡ªåŠ¨åˆ†æä»£ç ç»“æ„ã€æ€§èƒ½ï¼Œå¹¶åœ¨è¿è¡Œæ—¶æä¾›æ™ºèƒ½å»ºè®®ï¼\nç‚¹å‡»è¿™é‡Œæˆ–å³ä¸Šè§’\"åˆ†æä»ªè¡¨ç›˜\"æŒ‰é’®å¯ä»¥æŸ¥çœ‹è‡ªåŠ¨åˆ†æç»“æœå’Œæ•°æ®å¯è§†åŒ–é¢æ¿ï¼";
                addMessage("assistant", welcomeMsg);
                chatHistory.push({ role: "assistant", content: welcomeMsg });
            }
        }

        async function sendQuestion(question) {
            // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯åˆ°ç•Œé¢å’Œå†å²è®°å½•
            addMessage("user", question);
            chatHistory.push({ role: "user", content: question });
            
            questionInput.value = "";
            submitBtn.disabled = true;
            submitBtn.classList.add('opacity-70', 'cursor-not-allowed');
            clearBtn.disabled = true;
            switchToCodeBtn.disabled = true;
            switchToDashboardBtn.disabled = true; // æ–°å¢

            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€ï¼ˆé å·¦æ˜¾ç¤ºï¼‰
            const loadingDiv = document.createElement("div");
            loadingDiv.className = "flex items-start mb-4 message-in";
            loadingDiv.innerHTML = `
                <div class="w-10 h-10 rounded-full bg-gradient-to-br from-secondary to-secondary-light flex items-center justify-center text-white font-bold shadow-md mr-3">
                    <i class="fa fa-robot"></i>
                </div>
                <div class="bg-ai-bg rounded-2xl rounded-tl-none px-5 py-3 shadow-message typing-indicator">
                    <span></span><span></span><span></span>
                </div>
            `;
            chatContainer.appendChild(loadingDiv);
            scrollToBottom();

            try {
                const response = await fetch(OLLAMA_API, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        user_id: USER_ID,
                        model: "qwen:7b-chat-q4_0", 
                        messages: chatHistory, // å…³é”®ï¼šä¼ é€’å®Œæ•´çš„å†å²å¯¹è¯
                        stream: true, 
                        temperature: 0.7, 
                        max_tokens: 2048 
                    })
                });

                if (!response.ok) throw new Error(`API å“åº”é”™è¯¯ï¼š${response.status}`);

                // ç§»é™¤åŠ è½½çŠ¶æ€
                loadingDiv.remove();
                
                // åˆ›å»ºAIæ¶ˆæ¯å®¹å™¨ï¼ˆé å·¦æ˜¾ç¤ºï¼‰
                const aiMessageDiv = document.createElement("div");
                aiMessageDiv.className = "flex items-start mb-4 message-in";
                aiMessageDiv.innerHTML = `
                    <div class="w-10 h-10 rounded-full bg-gradient-to-br from-secondary to-secondary-light flex items-center justify-center text-white font-bold shadow-md mr-3">
                        <i class="fa fa-robot"></i>
                    </div>
                    <div class="bg-ai-bg rounded-2xl rounded-tl-none px-5 py-3 shadow-message max-w-[80%]"></div>
                `;
                chatContainer.appendChild(aiMessageDiv);
                scrollToBottom();

                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let aiAnswer = "";
                const contentEl = aiMessageDiv.querySelector("div:last-child");

                // å¤„ç†æµå¼å“åº”
                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;

                    const chunks = decoder.decode(value).split("\n").filter(chunk => chunk.trim());
                    for (const chunk of chunks) {
                        try {
                            const data = JSON.parse(chunk);
                            if (data.message?.content) {
                                aiAnswer += data.message.content;
                                contentEl.innerHTML = formatMessage(aiAnswer);
                                scrollToBottom();
                            }
                        } catch (e) {}
                    }
                }

                // å°†AIå›ç­”æ·»åŠ åˆ°å†å²è®°å½•
                if (aiAnswer) {
                    chatHistory.push({ role: "assistant", content: aiAnswer });
                } else {
                    contentEl.textContent = "æœªè·å–åˆ°å›ç­”ï¼Œè¯·é‡è¯•";
                }
            } catch (error) {
                loadingDiv.remove();
                addMessage("assistant", `å‡ºé”™äº†ï¼š${error.message}\nè¯·æ£€æŸ¥ Ollama æœåŠ¡æ˜¯å¦æ­£å¸¸è¿è¡Œ`);
            } finally {
                submitBtn.disabled = false;
                submitBtn.classList.remove('opacity-70', 'cursor-not-allowed');
                clearBtn.disabled = false;
                switchToCodeBtn.disabled = false;
                switchToDashboardBtn.disabled = false; // æ–°å¢
            }
        }

        // æ‰“å¼€ä»£ç åˆ†æå™¨
        function openCodeAnalyzerPage() {
            // æ£€æŸ¥ä»£ç åˆ†æå™¨é¡µé¢æ˜¯å¦å­˜åœ¨
            fetch(CODE_ANALYZER_URL, { method: 'HEAD' })
                .then(response => {
                    if (response.ok) {
                        window.open(CODE_ANALYZER_URL, '_blank');
                    } else {
                        alert('ä»£ç åˆ†æå™¨é¡µé¢æœªæ‰¾åˆ°ï¼Œè¯·ç¡®ä¿æœåŠ¡å·²å¯åŠ¨å¹¶åŒ…å« code_analysis.html æ–‡ä»¶');
                        // å¯é€‰ï¼šåˆ›å»ºä»£ç åˆ†æå™¨é¡µé¢
                        createCodeAnalyzerPage();
                    }
                })
                .catch(() => {
                    alert('æ— æ³•è®¿é—®ä»£ç åˆ†æå™¨ï¼Œè¯·æ£€æŸ¥æœåŠ¡æ˜¯å¦è¿è¡Œ');
                });
        }

        // æ–°å¢ï¼šæ‰“å¼€è‡ªåŠ¨åˆ†æä»ªè¡¨ç›˜
        function openAutoAnalysisDashboard() {
            // æ£€æŸ¥ä»ªè¡¨ç›˜é¡µé¢æ˜¯å¦å­˜åœ¨
            fetch(AUTO_ANALYSIS_DASHBOARD_URL, { method: 'HEAD' })
                .then(response => {
                    if (response.ok) {
                        window.open(AUTO_ANALYSIS_DASHBOARD_URL, '_blank');
                    } else {
                        alert('è‡ªåŠ¨åˆ†æä»ªè¡¨ç›˜é¡µé¢æœªæ‰¾åˆ°ï¼Œè¯·ç¡®ä¿æœåŠ¡å·²å¯åŠ¨å¹¶åŒ…å« auto_analysis_dashboard.html æ–‡ä»¶');
                    }
                })
                .catch(() => {
                    alert('æ— æ³•è®¿é—®è‡ªåŠ¨åˆ†æä»ªè¡¨ç›˜ï¼Œè¯·æ£€æŸ¥æœåŠ¡æ˜¯å¦è¿è¡Œ');
                });
        }

        // åˆ›å»ºä»£ç åˆ†æå™¨é¡µé¢ï¼ˆå¤‡ç”¨ï¼‰
        function createCodeAnalyzerPage() {
            // è¿™é‡Œå¯ä»¥æ·»åŠ åˆ›å»ºä»£ç åˆ†æé¡µé¢çš„é€»è¾‘
            // æˆ–è€…æç¤ºç”¨æˆ·å¦‚ä½•è·å–è¯¥é¡µé¢
            alert('è¯·åœ¨æœåŠ¡å™¨ç›®å½•ä¸­åˆ›å»º code_analysis.html æ–‡ä»¶ï¼Œæˆ–ä½¿ç”¨ä¹‹å‰æä¾›çš„å®Œæ•´ä»£ç ã€‚');
        }

        // æ˜¾ç¤ºä»£ç åˆ†ææ¨¡æ€æ¡†
        function showCodeModal() {
            codeModal.classList.remove('hidden');
            codeModal.classList.add('flex');
        }

        // éšè—ä»£ç åˆ†ææ¨¡æ€æ¡†
        function hideCodeModal() {
            codeModal.classList.add('hidden');
            codeModal.classList.remove('flex');
        }

        // äº‹ä»¶ç›‘å¬
        submitBtn.addEventListener("click", () => {
            const question = questionInput.value.trim();
            if (question) sendQuestion(question);
        });

        clearBtn.addEventListener("click", clearChat);

        // å¿«æ·å‘½ä»¤æŒ‰é’®
        document.querySelectorAll('.quick-command').forEach(button => {
            button.addEventListener('click', (e) => {
                const command = e.currentTarget.getAttribute('data-command');
                questionInput.value = command;
                questionInput.focus();
            });
        });

        questionInput.addEventListener("keydown", (e) => {
            // Shift+Enteræ¢è¡Œï¼ŒEnterå‘é€
            if (e.key === "Enter" && !e.shiftKey) {
                e.preventDefault();
                const question = questionInput.value.trim();
                if (question) sendQuestion(question);
            }
        });

        // ä»£ç åˆ†æç›¸å…³äº‹ä»¶
        switchToCodeBtn.addEventListener('click', openCodeAnalyzerPage);
        quickCodeBtn.addEventListener('click', showCodeModal);
        closeModal.addEventListener('click', hideCodeModal);
        codeAnalysisHint.addEventListener('click', showCodeModal);
        
        // æ–°å¢ï¼šä»ªè¡¨ç›˜ç›¸å…³äº‹ä»¶
        switchToDashboardBtn.addEventListener('click', openAutoAnalysisDashboard);
        quickDashboardBtn.addEventListener('click', openAutoAnalysisDashboard);
        dashboardHint.addEventListener('click', openAutoAnalysisDashboard);
        
        // æ¨¡æ€æ¡†èƒŒæ™¯ç‚¹å‡»å…³é—­
        codeModal.addEventListener('click', (e) => {
            if (e.target === codeModal) {
                hideCodeModal();
            }
        });

        openCodeAnalyzer.addEventListener('click', () => {
            hideCodeModal();
            openCodeAnalyzerPage();
        });

        pasteCodeHere.addEventListener('click', () => {
            hideCodeModal();
            // è¯»å–å‰ªè´´æ¿å†…å®¹
            navigator.clipboard.readText()
                .then(text => {
                    if (text.trim()) {
                        const codeAnalysisPrompt = `è¯·åˆ†æä»¥ä¸‹ä»£ç ï¼š\n\n\`\`\`\n${text}\n\`\`\`\n\nè¯·è¯´æ˜ï¼š\n1. ä»£ç çš„ä¸»è¦åŠŸèƒ½\n2. å…³é”®ç®—æ³•æˆ–é€»è¾‘\n3. å¯èƒ½çš„æ€§èƒ½é—®é¢˜\n4. æ”¹è¿›å»ºè®®`;
                        questionInput.value = codeAnalysisPrompt;
                        questionInput.focus();
                    } else {
                        alert('å‰ªè´´æ¿ä¸­æ²¡æœ‰æ£€æµ‹åˆ°æ–‡æœ¬å†…å®¹');
                    }
                })
                .catch(err => {
                    console.error('è¯»å–å‰ªè´´æ¿å¤±è´¥:', err);
                    questionInput.value = 'è¯·ç²˜è´´è¦åˆ†æçš„ä»£ç åˆ°è¿™é‡Œï¼Œæˆ‘ä¼šå¸®ä½ åˆ†æç»“æ„å’Œæ€§èƒ½é—®é¢˜ã€‚';
                    questionInput.focus();
                });
        });

        // åˆå§‹èšç„¦è¾“å…¥æ¡†
        questionInput.focus();
        
        // æ·»åŠ é”®ç›˜å¿«æ·é”®ï¼šCtrl+Shift+C æ‰“å¼€ä»£ç åˆ†æå™¨
        document.addEventListener('keydown', (e) => {
            if (e.ctrlKey && e.shiftKey && e.key === 'C') {
                e.preventDefault();
                showCodeModal();
            }
            // æ–°å¢ï¼šCtrl+Shift+D æ‰“å¼€ä»ªè¡¨ç›˜
            if (e.ctrlKey && e.shiftKey && e.key === 'D') {
                e.preventDefault();
                openAutoAnalysisDashboard();
            }
        });
        
        // æ·»åŠ é¡µé¢åˆ‡æ¢æç¤º
        console.log('ğŸ’¡ æç¤ºï¼šç‚¹å‡»å³ä¸Šè§’"ä»£ç åˆ†æå™¨"æŒ‰é’®æˆ–æŒ‰ Ctrl+Shift+C æ‰“å¼€ä»£ç åˆ†æå·¥å…·');
        console.log('ğŸ“Š æç¤ºï¼šç‚¹å‡»å³ä¸Šè§’"åˆ†æä»ªè¡¨ç›˜"æŒ‰é’®æˆ–æŒ‰ Ctrl+Shift+D æ‰“å¼€è‡ªåŠ¨åˆ†æä»ªè¡¨ç›˜');
    </script>
</body>
</html>